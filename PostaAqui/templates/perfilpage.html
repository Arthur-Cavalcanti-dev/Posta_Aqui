{% extends "homepage.html" %}

{% block titulo %}
PostaAqui - {{ usuario.name }}
{% endblock %}

{% block Perfil %}
<div class="perfil-title">
  Perfil - {{ usuario.name }}
</div>
{% endblock %}

{% block body %}

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} mt-3 flash-message" role="alert">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<link rel="stylesheet" href="{{ url_for('static', filename='css/perfil.css') }}">

<div class="titulo-com-mascote">
  <img 
    class="mascote-principal" 
    src="{{ url_for('static', filename='imagens_site/Life_5.png') }}" 
    alt="Mascote principal"
  >
  <h1 class="main-title">Posta Aqui</h1>
  {% include 'nav.html' %}
</div>

<h1 class="perfil-title"><p>Perfil do usu√°rio: {{ usuario.name }}</p></h1>

{% if form %}
<div class="form-wrapper">
  <div class="upload-card two-columns">
    <form method="POST" enctype="multipart/form-data" class="perfil-form">
      {{ form.hidden_tag() }}
      <div class="upload-section">
        <div class="drop-area" id="drop-area">
          <p>Arraste e solte a imagem aqui<br>ou clique para escolher</p>
          <label for="file-upload" class="custom-file-upload">üìÅ Escolher arquivo</label>
          {{ form.foto(id="file-upload", class="hidden-input", accept=".jpg,.jpeg,.png,.gif,.webp,.bmp,.tiff") }}
        </div>
      </div>

      <div class="input-section">
        <div class="form-group">
          {{ form.nome_foto.label(class="form-label") }}
          {{ form.nome_foto(class="form-input") }}
        </div>
        <div class="form-group">
          {{ form.tag.label(class="form-label") }}
          {{ form.tag(class="form-input") }}
        </div>
        <button type="submit" class="btn-submit">Enviar</button>
      </div>
    </form>
  </div>
</div>
{% endif %}

<div id="galeria" class="fotos-galeria hidden-on-mobile">
  {% for foto in usuario.fotos %}
  <div class="foto-container">
    <a href="{{ url_for('static', filename='post/' + foto.imagem) }}" target="_blank">
      <img 
        class="foto-imagem" 
        src="{{ url_for('static', filename='post/' + foto.imagem) }}" 
        alt="{{ foto.nome_foto }}">
    </a>
    <p class="foto-nome">{{ foto.nome_foto }}</p>
    
    <div class="foto-acoes">
      <a href="{{ url_for('Download_de_Arquivos', filename=foto.imagem) }}" download>
        <button class="btn btn-download">‚¨áÔ∏è Baixar</button>
      </a>
      <a href="{{ url_for('denuncia_foto', filename=foto.imagem) }}">
        <button class="btn btn-denunciar">üö´ Denunciar</button>
      </a>
      {% if current_user.id == foto.id_usuario %}
      <a href="{{ url_for('excluir_arquivos', id_usuario=foto.id_usuario, filename=foto.imagem) }}">
        <button class="btn btn-delete">‚ùå Excluir</button>
      </a>
      {% endif %}
    </div>
  </div>
  {% endfor %}
</div>

<script>
  const dropArea = document.getElementById('drop-area');
  const fileInput = document.getElementById('file-upload');
  const galeria = document.getElementById('galeria');

  fileInput.addEventListener('change', e => {
  const file = e.target.files[0];
  applyPreview(file);

    if (window.innerWidth <= 768 && file) {
    galeria.classList.remove('hidden-on-mobile');
    galeria.classList.add('show-on-mobile');
    }
  });


  const applyPreview = (file) => {
    if (file && file.type.startsWith('image/')) {
      const reader = new FileReader();
      reader.onload = function(e) {
        dropArea.classList.add('preview');
        dropArea.style.setProperty('--preview-image', `url('${e.target.result}')`);
      }
      reader.readAsDataURL(file);
    } else {
      dropArea.classList.remove('preview');
      dropArea.style.removeProperty('--preview-image');
    }
  };

  // Eventos para prevenir comportamento padr√£o
  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, e => {
      e.preventDefault();
      e.stopPropagation();
    });
  });

  // Quando arquivo √© solto
  dropArea.addEventListener('drop', e => {
    const file = e.dataTransfer.files[0];
    fileInput.files = e.dataTransfer.files;
    applyPreview(file);
  });

  // Quando arquivo √© selecionado pelo input
  fileInput.addEventListener('change', e => {
    const file = e.target.files[0];
    applyPreview(file);
  });

  // Ao clicar na √°rea de drop, ativa input
  dropArea.addEventListener('click', () => {
    fileInput.click();
  });
</script>

{% include "routes_nav.html" %}

{% endblock %}